name: CI Test (branch ci-test)

on:
  push:
    branches: [ci-test]
  workflow_dispatch: {}

# Avoid stacking older test runs; keep latest active
concurrency:
  group: ci-test-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  fast-checks:
    name: Fast checks (lint + types)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Enable corepack & pnpm
        run: |
          corepack enable
          pnpm -v

      - name: Install deps (workspace)
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm -w lint --if-present

      - name: Typecheck
        run: pnpm -w check-types

  build-samples:
    name: Build key apps (web + docs)
    runs-on: ubuntu-latest
    needs: fast-checks
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Enable corepack & pnpm
        run: |
          corepack enable
          pnpm -v

      - name: Install deps (workspace)
        run: pnpm install --frozen-lockfile

      - name: Cache turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ci-test-turbo-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Cache Next.js web
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: ci-test-next-web-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Cache Next.js docs
        uses: actions/cache@v4
        with:
          path: apps/docs/.next/cache
          key: ci-test-next-docs-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Build UI package
        run: pnpm -w -F @repo/ui build:ui || echo 'UI package build optional'

      - name: Build web app
        run: pnpm -w -F web build

      - name: Build docs app
        run: pnpm -w -F docs build

      - name: Verify outputs
        run: |
          test -f apps/web/.next/BUILD_ID && echo 'web build ok' || (echo 'web build missing' && exit 1)
          test -f apps/docs/.next/BUILD_ID && echo 'docs build ok' || (echo 'docs build missing' && exit 1)

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [fast-checks, build-samples]
    if: always()
    steps:
      - name: Print result matrix
        run: |
          echo 'Fast checks conclusion: ${{ needs.fast-checks.result }}'
          echo 'Build samples conclusion: ${{ needs.build-samples.result }}'
          if [ "${{ needs.fast-checks.result }}" != "success" ] || [ "${{ needs.build-samples.result }}" != "success" ]; then
            echo 'One or more jobs failed.'
            exit 1
          fi

# IMPORTANT: no deploy or release steps here. This branch isolates CI experimentation.
